@using booksite.Models
@{
    ViewData["Title"] = "Вход в систему";
    var returnUrl = Context.Request.Query["returnUrl"];
    var register = Context.Request.Query["register"];
    var isAuthenticated = Context.User.Identity?.IsAuthenticated ?? false;
}

@if (isAuthenticated)
{
    <script>
        window.location.href = '/';
    </script>
}
else
{
    <div class="main">
        <input type="checkbox" id="chk" aria-hidden="true" @(register == "true" ? "checked" : "")>

        <div class="signup">
            <form method="post" action="/Account/Register" autocomplete="on">
                @Html.AntiForgeryToken()

                <label for="chk" aria-hidden="true">Регистрация</label>

                @if (TempData["Success"] != null)
                {
                    <div style="color: #4CAF50; text-align: center; margin: 10px; padding: 10px; background: rgba(76, 175, 80, 0.1); border-radius: 5px;">
                        @TempData["Success"]
                    </div>
                }

                @if (ViewData.ModelState[""]?.Errors?.Count > 0)
                {
                    <div style="color: #ff6b6b; text-align: center; margin: 10px; padding: 10px; background: rgba(255, 107, 107, 0.1); border-radius: 5px;">
                        @ViewData.ModelState[""].Errors[0].ErrorMessage
                    </div>
                }

                <input type="text"
                       name="Username"
                       placeholder="Имя пользователя"
                       required
                       value="@ViewData.ModelState["Username"]?.AttemptedValue"
                       class="@(ViewData.ModelState["Username"]?.Errors?.Count > 0 ? "is-invalid" : "")">
                @if (ViewData.ModelState["Username"]?.Errors?.Count > 0)
                {
                    <div style="color: #ff6b6b; font-size: 0.8em; margin-top: -10px; margin-bottom: 10px; text-align: center;">
                        @ViewData.ModelState["Username"].Errors[0].ErrorMessage
                    </div>
                }

                <input type="email"
                       name="Email"
                       placeholder="Email"
                       required
                       value="@ViewData.ModelState["Email"]?.AttemptedValue"
                       class="@(ViewData.ModelState["Email"]?.Errors?.Count > 0 ? "is-invalid" : "")">
                @if (ViewData.ModelState["Email"]?.Errors?.Count > 0)
                {
                    <div style="color: #ff6b6b; font-size: 0.8em; margin-top: -10px; margin-bottom: 10px; text-align: center;">
                        @ViewData.ModelState["Email"].Errors[0].ErrorMessage
                    </div>
                }

                <input type="tel"
                       name="Phone"
                       placeholder="Номер телефона"
                       value="@ViewData.ModelState["Phone"]?.AttemptedValue">

                <input type="password"
                       name="Password"
                       placeholder="Пароль"
                       required
                       class="@(ViewData.ModelState["Password"]?.Errors?.Count > 0 ? "is-invalid" : "")">
                @if (ViewData.ModelState["Password"]?.Errors?.Count > 0)
                {
                    <div style="color: #ff6b6b; font-size: 0.8em; margin-top: -10px; margin-bottom: 10px; text-align: center;">
                        @ViewData.ModelState["Password"].Errors[0].ErrorMessage
                    </div>
                }

                <input type="password"
                       name="ConfirmPassword"
                       placeholder="Подтвердите пароль"
                       required
                       class="@(ViewData.ModelState["ConfirmPassword"]?.Errors?.Count > 0 ? "is-invalid" : "")">
                @if (ViewData.ModelState["ConfirmPassword"]?.Errors?.Count > 0)
                {
                    <div style="color: #ff6b6b; font-size: 0.8em; margin-top: -10px; margin-bottom: 10px; text-align: center;">
                        @ViewData.ModelState["ConfirmPassword"].Errors[0].ErrorMessage
                    </div>
                }

                <button type="submit">Зарегистрироваться</button>
            </form>
        </div>

        <div class="login">
            <form method="post" action="/Account/Login" autocomplete="on">
                @Html.AntiForgeryToken()
                <input type="hidden" name="returnUrl" value="@returnUrl">

                <label for="chk" aria-hidden="true">Вход</label>

                @if (TempData["Success"] != null && register != "true")
                {
                    <div style="color: #4CAF50; text-align: center; margin: 10px; padding: 10px; background: rgba(76, 175, 80, 0.1); border-radius: 5px;">
                        @TempData["Success"]
                    </div>
                }

                @if (ViewData.ModelState[""]?.Errors?.Count > 0 && register != "true")
                {
                    <div style="color: #ff6b6b; text-align: center; margin: 10px; padding: 10px; background: rgba(255, 107, 107, 0.1); border-radius: 5px;">
                        @ViewData.ModelState[""].Errors[0].ErrorMessage
                    </div>
                }

                <input type="text"
                       name="username"
                       placeholder="Email или имя пользователя"
                       required
                       value="@ViewData.ModelState["username"]?.AttemptedValue"
                       class="@(ViewData.ModelState["username"]?.Errors?.Count > 0 ? "is-invalid" : "")">
                @if (ViewData.ModelState["username"]?.Errors?.Count > 0)
                {
                    <div style="color: #ff6b6b; font-size: 0.8em; margin-top: -10px; margin-bottom: 10px; text-align: center;">
                        @ViewData.ModelState["username"].Errors[0].ErrorMessage
                    </div>
                }

                <input type="password"
                       name="password"
                       placeholder="Пароль"
                       required
                       class="@(ViewData.ModelState["password"]?.Errors?.Count > 0 ? "is-invalid" : "")">
                @if (ViewData.ModelState["password"]?.Errors?.Count > 0)
                {
                    <div style="color: #ff6b6b; font-size: 0.8em; margin-top: -10px; margin-bottom: 10px; text-align: center;">
                        @ViewData.ModelState["password"].Errors[0].ErrorMessage
                    </div>
                }

                <div style="display: flex; align-items: center; justify-content: center; margin: 10px auto; width: 60%;">
                    <input type="checkbox" name="rememberMe" id="loginkeeping" value="true" style="width: auto; margin: 0 10px 0 0;">
                    <label for="loginkeeping" style="color: #573b8a; font-size: 0.9em; margin: 0; cursor: pointer;">Запомнить меня</label>
                </div>

                <button type="submit">Войти</button>
            </form>
        </div>
    </div>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: 'Jost', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .content-wrapper {
            background: transparent;
            box-shadow: none;
            padding: 0;
            margin: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .main {
            width: 350px;
            height: 500px;
            overflow: hidden;
            background: linear-gradient(to bottom, #0f0c29, #302b63, #24243e);
            border-radius: 10px;
            box-shadow: 5px 20px 50px rgba(0, 0, 0, 0.5);
        }

        #chk {
            display: none;
        }

        .signup {
            position: relative;
            width: 100%;
            height: 100%;
        }

            .signup label {
                color: #fff;
                font-size: 2.3em;
                justify-content: center;
                display: flex;
                margin: 50px;
                font-weight: bold;
                cursor: pointer;
                transition: .5s ease-in-out;
            }

        input {
            width: 60%;
            height: 10px;
            background: #e0dede;
            justify-content: center;
            display: flex;
            margin: 20px auto;
            padding: 12px;
            border: none;
            outline: none;
            border-radius: 5px;
            font-size: 14px;
        }

            input.is-invalid {
                border: 2px solid #ff6b6b;
                background: #ffeaea;
            }

        button {
            width: 60%;
            height: 40px;
            margin: 10px auto;
            justify-content: center;
            display: block;
            color: #fff;
            background: #573b8a;
            font-size: 1em;
            font-weight: bold;
            margin-top: 20px;
            outline: none;
            border: none;
            border-radius: 5px;
            transition: .2s ease-in;
            cursor: pointer;
        }

            button:hover {
                background: #6d44b8;
            }

        .login {
            height: 460px;
            background: #eee;
            border-radius: 60% / 10%;
            transform: translateY(-180px);
            transition: .8s ease-in-out;
        }

            .login label {
                color: #573b8a;
                transform: scale(.6);
                margin-top: 70px;
            }

        #chk:checked ~ .login {
            transform: translateY(-500px);
        }

            #chk:checked ~ .login label {
                transform: scale(1);
            }

        #chk:checked ~ .signup label {
            transform: scale(.6);
        }

        /* Адаптивность */
        @@media (max-width: 768px) {
            .main {
                width: 320px;
                height: 480px;
            }

            input, button {
                width: 70%;
            }
        }

        @@media (max-width: 480px) {
            .main {
                width: 300px;
                height: 450px;
            }

            .signup label, .login label {
                font-size: 2em;
                margin: 40px;
            }
        }
    </style>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Автоматически переключаем на регистрацию если есть ошибки регистрации
            const hasRegisterErrors = document.querySelector('.signup .is-invalid');
            if (hasRegisterErrors) {
                document.getElementById('chk').checked = true;
            }

            // Валидация пароля
            const passwordInput = document.querySelector('.signup input[name="Password"]');
            const confirmPasswordInput = document.querySelector('.signup input[name="ConfirmPassword"]');

            if (passwordInput && confirmPasswordInput) {
                function validatePasswordMatch() {
                    const password = passwordInput.value;
                    const confirmPassword = confirmPasswordInput.value;

                    if (confirmPassword && password !== confirmPassword) {
                        confirmPasswordInput.classList.add('is-invalid');
                        confirmPasswordInput.style.border = '2px solid #ff6b6b';
                    } else {
                        confirmPasswordInput.classList.remove('is-invalid');
                        confirmPasswordInput.style.border = '';
                    }
                }

                passwordInput.addEventListener('input', validatePasswordMatch);
                confirmPasswordInput.addEventListener('input', validatePasswordMatch);
            }

            // Если в URL есть #tosubscribe, показываем регистрацию
            if (window.location.hash === '#tosubscribe') {
                document.getElementById('chk').checked = true;
            }

            // Обработка ссылок переключения
            const chk = document.getElementById('chk');
            chk.addEventListener('change', function() {
                if (this.checked) {
                    history.pushState(null, null, '#tosubscribe');
                } else {
                    history.pushState(null, null, '#tologin');
                }
            });

            // Обработка истории браузера
            window.addEventListener('popstate', function() {
                if (window.location.hash === '#tosubscribe') {
                    chk.checked = true;
                } else {
                    chk.checked = false;
                }
            });
        });
    </script>
}
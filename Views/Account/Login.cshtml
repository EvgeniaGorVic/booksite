@using booksite.Models
@{
    ViewData["Title"] = "Вход в систему";
    var returnUrl = Context.Request.Query["returnUrl"];
    var register = Context.Request.Query["register"];
    var isAuthenticated = Context.User.Identity?.IsAuthenticated ?? false;
}

@if (isAuthenticated)
{
    <script>
        window.location.href = '/';
    </script>
}
else
{
    <div class="auth-container">
        <div class="auth-wrapper">
            <div class="auth-left">
                <h2 class="auth-title">Добро пожаловать!</h2>
                <p class="auth-subtitle">
                    Войдите в свою учетную запись или создайте новую, чтобы получить доступ ко всем функциям BookSite
                </p>
                <ul class="features-list">
                    <li>Доступ к полному каталогу книг</li>
                    <li>Избранные книги и история просмотров</li>
                    <li>Быстрое оформление заказов</li>
                    <li>Специальные предложения и скидки</li>
                </ul>
            </div>

            <div class="auth-right">
                @if (register == "true")
                {
                    <!-- Форма регистрации -->
                    <h3 class="text-center mb-4">Регистрация</h3>

                    @if (TempData["Success"] != null)
                    {
                        <div class="alert alert-success">
                            @TempData["Success"]
                        </div>
                    }

                    <form method="post" action="/Account/Register" autocomplete="on">
                        @Html.AntiForgeryToken()

                        <div class="form-group">
                            <label for="Username" class="form-label">Имя пользователя *</label>
                            <input type="text"
                                   id="Username"
                                   name="Username"
                                   class="form-control @(ViewData.ModelState["Username"]?.Errors?.Count > 0 ? "is-invalid" : "")"
                                   placeholder="Введите имя пользователя"
                                   required
                                   value="@ViewData.ModelState["Username"]?.AttemptedValue">
                            @if (ViewData.ModelState["Username"]?.Errors?.Count > 0)
                            {
                                <div class="invalid-feedback">
                                    @ViewData.ModelState["Username"].Errors[0].ErrorMessage
                                </div>
                            }
                        </div>

                        <div class="form-group">
                            <label for="Email" class="form-label">Email *</label>
                            <input type="email"
                                   id="Email"
                                   name="Email"
                                   class="form-control @(ViewData.ModelState["Email"]?.Errors?.Count > 0 ? "is-invalid" : "")"
                                   placeholder="Введите email"
                                   required
                                   value="@ViewData.ModelState["Email"]?.AttemptedValue">
                            @if (ViewData.ModelState["Email"]?.Errors?.Count > 0)
                            {
                                <div class="invalid-feedback">
                                    @ViewData.ModelState["Email"].Errors[0].ErrorMessage
                                </div>
                            }
                        </div>

                        <div class="form-group">
                            <label for="Phone" class="form-label">Телефон</label>
                            <input type="tel"
                                   id="Phone"
                                   name="Phone"
                                   class="form-control"
                                   placeholder="Введите номер телефона"
                                   value="@ViewData.ModelState["Phone"]?.AttemptedValue">
                        </div>

                        <div class="form-group">
                            <label for="Password" class="form-label">Пароль *</label>
                            <input type="password"
                                   id="Password"
                                   name="Password"
                                   class="form-control @(ViewData.ModelState["Password"]?.Errors?.Count > 0 ? "is-invalid" : "")"
                                   placeholder="Введите пароль"
                                   required>
                            @if (ViewData.ModelState["Password"]?.Errors?.Count > 0)
                            {
                                <div class="invalid-feedback">
                                    @ViewData.ModelState["Password"].Errors[0].ErrorMessage
                                </div>
                            }
                        </div>

                        <div class="form-group">
                            <label for="ConfirmPassword" class="form-label">Подтверждение пароля *</label>
                            <input type="password"
                                   id="ConfirmPassword"
                                   name="ConfirmPassword"
                                   class="form-control @(ViewData.ModelState["ConfirmPassword"]?.Errors?.Count > 0 ? "is-invalid" : "")"
                                   placeholder="Повторите пароль"
                                   required>
                            @if (ViewData.ModelState["ConfirmPassword"]?.Errors?.Count > 0)
                            {
                                <div class="invalid-feedback">
                                    @ViewData.ModelState["ConfirmPassword"].Errors[0].ErrorMessage
                                </div>
                            }
                        </div>

                        @if (ViewData.ModelState[""]?.Errors?.Count > 0)
                        {
                            <div class="alert alert-danger">
                                @ViewData.ModelState[""].Errors[0].ErrorMessage
                            </div>
                        }

                        <button type="submit" class="btn btn-primary btn-block btn-lg mt-3">
                            Зарегистрироваться
                        </button>

                        <div class="text-center mt-3">
                            <a href="/Account/Login" class="text-primary">
                                <i class="fas fa-sign-in-alt me-1"></i>Уже есть аккаунт? Войти
                            </a>
                        </div>
                    </form>
                }
                else
                {
                    <!-- Форма входа -->
                    <h3 class="text-center mb-4">Вход в систему</h3>

                    @if (TempData["Success"] != null)
                    {
                        <div class="alert alert-success">
                            @TempData["Success"]
                        </div>
                    }

                    <form method="post" action="/Account/Login" autocomplete="on">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="returnUrl" value="@returnUrl">

                        <div class="form-group">
                            <label for="username" class="form-label">Email или имя пользователя *</label>
                            <input type="text"
                                   id="username"
                                   name="username"
                                   class="form-control @(ViewData.ModelState["username"]?.Errors?.Count > 0 ? "is-invalid" : "")"
                                   placeholder="Введите email или имя пользователя"
                                   required
                                   value="@ViewData.ModelState["username"]?.AttemptedValue">
                            @if (ViewData.ModelState["username"]?.Errors?.Count > 0)
                            {
                                <div class="invalid-feedback">
                                    @ViewData.ModelState["username"].Errors[0].ErrorMessage
                                </div>
                            }
                        </div>

                        <div class="form-group">
                            <label for="password" class="form-label">Пароль *</label>
                            <input type="password"
                                   id="password"
                                   name="password"
                                   class="form-control @(ViewData.ModelState["password"]?.Errors?.Count > 0 ? "is-invalid" : "")"
                                   placeholder="Введите пароль"
                                   required>
                            @if (ViewData.ModelState["password"]?.Errors?.Count > 0)
                            {
                                <div class="invalid-feedback">
                                    @ViewData.ModelState["password"].Errors[0].ErrorMessage
                                </div>
                            }
                        </div>

                        <div class="form-check mb-3">
                            <input type="checkbox"
                                   id="rememberMe"
                                   name="rememberMe"
                                   class="form-check-input"
                                   value="true">
                            <label for="rememberMe" class="form-check-label">Запомнить меня</label>
                        </div>

                        @if (ViewData.ModelState[""]?.Errors?.Count > 0)
                        {
                            <div class="alert alert-danger">
                                @ViewData.ModelState[""].Errors[0].ErrorMessage
                            </div>
                        }

                        <button type="submit" class="btn btn-primary btn-block btn-lg">
                            Войти
                        </button>

                        <div class="text-center mt-3">
                            <a href="/Account/Login?register=true" class="text-primary">
                                <i class="fas fa-user-plus me-1"></i>Нет аккаунта? Зарегистрироваться
                            </a>
                        </div>
                    </form>
                }
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const passwordInput = document.getElementById('Password');
            const confirmPasswordInput = document.getElementById('ConfirmPassword');

            if (passwordInput && confirmPasswordInput) {
                function validatePasswordMatch() {
                    const password = passwordInput.value;
                    const confirmPassword = confirmPasswordInput.value;

                    if (confirmPassword && password !== confirmPassword) {
                        confirmPasswordInput.classList.add('is-invalid');
                        if (!confirmPasswordInput.nextElementSibling ||
                            !confirmPasswordInput.nextElementSibling.classList.contains('invalid-feedback')) {
                            const errorDiv = document.createElement('div');
                            errorDiv.className = 'invalid-feedback';
                            errorDiv.textContent = 'Пароли не совпадают';
                            confirmPasswordInput.parentNode.insertBefore(errorDiv, confirmPasswordInput.nextSibling);
                        }
                    } else {
                        confirmPasswordInput.classList.remove('is-invalid');
                        const errorDiv = confirmPasswordInput.nextElementSibling;
                        if (errorDiv && errorDiv.classList.contains('invalid-feedback')) {
                            errorDiv.remove();
                        }
                    }
                }

                passwordInput.addEventListener('input', validatePasswordMatch);
                confirmPasswordInput.addEventListener('input', validatePasswordMatch);
                validatePasswordMatch();
            }

            const registerForm = document.querySelector('form[action="/Account/Register"]');
            if (registerForm) {
                registerForm.addEventListener('submit', function (e) {
                    const password = document.getElementById('Password')?.value;
                    const confirmPassword = document.getElementById('ConfirmPassword')?.value;

                    if (password && confirmPassword && password !== confirmPassword) {
                        e.preventDefault();
                        alert('Пароли не совпадают!');
                        return false;
                    }
                    return true;
                });
            }
        });
    </script>
}